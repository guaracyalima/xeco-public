# üß™ Guia de Testes - Sistema de Afiliados com Wallet Management

## üìã Pr√©-requisitos

1. ‚úÖ Servidor dev rodando: `npm run dev`
2. ‚úÖ Firebase configurado (.env.local com credenciais)
3. ‚úÖ Pelo menos 1 empresa ativa no Firestore
4. ‚úÖ Usu√°rio de teste com CPF/CNPJ cadastrado

---

## üéØ Cen√°rios de Teste

### **Cen√°rio 1: Afiliado SEM empresa pr√≥pria (conta pessoal nova)**

Este √© o caso mais simples - afiliado n√£o tem franquia.

#### **Passo a Passo:**

```bash
# 1. Crie o convite de teste
node scripts/create-test-affiliate-invite.js

# 2. Copie o link gerado (exemplo):
# http://localhost:3000/affiliate/accept?token=abc123...
```

#### **3. Abra o link no navegador**

**Estado esperado: N√ÉO LOGADO**
- ‚úÖ Deve mostrar tela de login
- ‚úÖ Bot√µes "Fazer Login" e "Criar Conta"
- ‚úÖ Detalhes do convite vis√≠veis

**4. Fa√ßa login com usu√°rio SEM empresa**
```
Email: teste@email.com
Senha: sua-senha
```

**5. Clique em "Aceitar Convite"**

**Estado esperado: PROCESSANDO**
- ‚úÖ Bot√£o muda para "Aceitando convite..."
- ‚úÖ Loading spinner aparece

**Estado esperado: SUCESSO**
- ‚úÖ Tela de parab√©ns aparece
- üü© **Box VERDE**: "Conta Pessoal Ativa"
- ‚úÖ Mensagem: "Suas comiss√µes ser√£o depositadas na sua conta pessoal Asaas"
- ‚úÖ Informa√ß√µes da parceria mostradas
- ‚úÖ Bot√£o "Ir para Painel de Afiliado"

**6. Clique em "Ir para Painel de Afiliado"**

**Estado esperado: DASHBOARD**
- ‚úÖ Redireciona para `/perfil?tab=afiliacao`
- ‚úÖ Card da empresa aparece
- ‚úÖ C√≥digo do cupom vis√≠vel
- ‚úÖ Estat√≠sticas zeradas (0 vendas)
- ‚ùå **N√ÉO deve ter aviso amarelo** (wallet n√£o √© compartilhada)

---

### **Cen√°rio 2: Afiliado QUE J√Å TEM empresa (wallet compartilhada)**

Este √© o caso cr√≠tico que o sistema foi feito para resolver!

#### **Prepara√ß√£o:**

```javascript
// No Firebase Console, verifique:
// 1. Empresa X tem:
//    - walletId: "wallet-abc-123"
//    - document_number: "12345678900" (CPF do dono)

// 2. Usu√°rio Y (que vai aceitar convite):
//    - document_number: "12345678900" (MESMO CPF da empresa X!)
```

#### **Teste:**

**1. Crie convite para empresa DIFERENTE da que o usu√°rio possui**
```bash
node scripts/create-test-affiliate-invite.js
# Isso vai criar convite para empresa A
```

**2. Abra link e fa√ßa login com usu√°rio que √© DONO da empresa B**
- Importante: Empresa B tem o MESMO CPF/CNPJ do usu√°rio
- Mas o convite √© para ser afiliado da empresa A

**3. Aceite o convite**

**Estado esperado: SUCESSO COM AVISO**
- ‚úÖ Tela de parab√©ns aparece
- üü® **Box AMARELO**: "Conta Compartilhada com Franquia"
- ‚úÖ Mensagem: "Suas comiss√µes desta afilia√ß√£o est√£o sendo depositadas na conta digital da sua franquia **[Nome da Empresa B]**"
- ‚úÖ Explica√ß√£o sobre limita√ß√£o da Asaas
- ‚úÖ Orienta√ß√£o para verificar extrato da empresa

**4. V√° para o dashboard**

**Estado esperado: AVISO PERMANENTE**
- ‚úÖ Card da afilia√ß√£o aparece
- üü® **Box AMARELO permanente** no topo do card
- ‚úÖ Texto: "Conta Compartilhada com Franquia"
- ‚úÖ Mostra nome da empresa pr√≥pria
- ‚úÖ Instru√ß√£o para verificar extrato

---

### **Cen√°rio 3: Convite Inv√°lido/Expirado**

#### **Teste 1: Token inv√°lido**
```bash
# Abra URL com token falso
http://localhost:3000/affiliate/accept?token=token-invalido-123
```

**Estado esperado:**
- ‚ùå √çcone de erro vermelho
- ‚ùå Mensagem: "Convite n√£o encontrado"
- ‚úÖ Bot√£o "Voltar ao In√≠cio"

#### **Teste 2: Convite j√° usado**
```bash
# 1. Aceite um convite normalmente
# 2. Tente abrir o mesmo link novamente
```

**Estado esperado:**
- ‚ùå Mensagem: "Convite j√° foi utilizado"

#### **Teste 3: Convite expirado**
```javascript
// No Firestore, edite o convite:
{
  expiresAt: Timestamp do passado
}
```

**Estado esperado:**
- ‚ùå Mensagem: "Convite expirado"

---

### **Cen√°rio 4: Valida√ß√£o de Dados**

#### **Teste 1: Usu√°rio sem CPF cadastrado**

**Prepara√ß√£o:**
```javascript
// No Firestore, usu√°rio sem document_number:
{
  email: "sem-cpf@email.com",
  fullName: "Usu√°rio Teste",
  // document_number: undefined ‚ùå
}
```

**Estado esperado:**
- ‚ùå Erro: "Usu√°rio n√£o possui CPF/CNPJ cadastrado. Por favor, complete seu perfil antes de aceitar o convite."

#### **Teste 2: Usu√°rio sem nome completo**
```javascript
{
  email: "sem-nome@email.com",
  document_number: "12345678900",
  // fullName: undefined ‚ùå
}
```

**Estado esperado:**
- ‚ùå Erro: "Dados incompletos. Por favor, complete seu perfil (nome completo e email) antes de aceitar o convite."

---

## üîç Verifica√ß√£o no Firestore

### **Ap√≥s aceitar convite com sucesso:**

#### **1. Collection: `affiliated`**
```javascript
{
  id: "aff_abc123",
  user: "userId_123",
  company_relationed: "companyId_xyz",
  walletId: "wallet-id-aqui",
  walletSource: "personal" | "company", // ‚Üê VERIFICAR
  ownCompanyId: "companyId_do_afiliado" | undefined, // ‚Üê SE wallet compartilhada
  commissionRate: 10,
  active: true,
  email: "afiliado@email.com",
  name: "Nome do Afiliado",
  createdAt: Timestamp,
  updatedAt: Timestamp
}
```

**Valida√ß√µes:**
- ‚úÖ `walletSource` deve ser "personal" OU "company"
- ‚úÖ Se `walletSource === "company"`, `ownCompanyId` DEVE existir
- ‚úÖ `walletId` deve corresponder ao da empresa pr√≥pria se compartilhado

#### **2. Collection: `affiliate_invitations`**
```javascript
{
  status: "ACCEPTED", // ‚Üê Mudou de PENDING
  acceptedAt: Timestamp, // ‚Üê Novo campo
  acceptedBy: "userId_123", // ‚Üê Novo campo
  affiliatedId: "aff_abc123" // ‚Üê Novo campo
}
```

#### **3. Collection: `affiliate_asaas_accounts` (se conta nova criada)**
```javascript
{
  userId: "userId_123",
  walletId: "wallet-novo-123",
  accountId: "asaas-account-id",
  cpfCnpj: "12345678900",
  createdAt: Timestamp
}
```

---

## üõ†Ô∏è Testes de API Diretamente

### **Teste 1: Validar Convite**
```bash
# Substitua TOKEN_AQUI pelo token real
curl http://localhost:3000/api/affiliate/validate-invite?token=TOKEN_AQUI
```

**Resposta esperada (sucesso):**
```json
{
  "storeId": "comp_123",
  "storeName": "Loja Teste",
  "storeOwnerName": "Jo√£o Silva",
  "commissionRate": 10,
  "message": "Seja nosso afiliado!",
  "expiresAt": "2025-11-30T00:00:00.000Z",
  "recipientEmail": "teste@email.com"
}
```

**Resposta esperada (erro):**
```json
{
  "error": "Convite n√£o encontrado"
}
```

### **Teste 2: Aceitar Convite**
```bash
curl -X POST http://localhost:3000/api/affiliate/accept-invite \
  -H "Content-Type: application/json" \
  -d '{
    "token": "TOKEN_AQUI",
    "userId": "USER_ID_AQUI"
  }'
```

**Resposta esperada (sucesso - wallet pessoal):**
```json
{
  "success": true,
  "affiliateId": "aff_abc123",
  "walletSource": "personal",
  "companyName": null,
  "message": "Suas comiss√µes ser√£o depositadas na sua conta pessoal Asaas"
}
```

**Resposta esperada (sucesso - wallet compartilhada):**
```json
{
  "success": true,
  "affiliateId": "aff_abc123",
  "walletSource": "company",
  "companyName": "Minha Franquia XPTO",
  "message": "Suas comiss√µes ser√£o depositadas na conta da sua franquia \"Minha Franquia XPTO\""
}
```

---

## üß™ Teste do ExternalReference no Checkout

### **Cen√°rio: Compra com cupom de afiliado**

**1. Crie um cupom para o afiliado:**
```javascript
// Firestore ‚Üí coupons
{
  code: "AFIL10",
  affiliateId: "aff_abc123",
  discountPercentage: 10,
  isActive: true,
  expiresAt: Timestamp futuro
}
```

**2. Fa√ßa uma compra usando o cupom:**
- Adicione produtos ao carrinho
- Aplique cupom "AFIL10"
- Finalize checkout

**3. Inspecione o payload enviado ao N8N:**

Procure nos logs do servidor por:
```
üè∑Ô∏è ExternalReference com dados de afiliado:
```

Voc√™ deve ver algo como:
```json
"{\"type\":\"AFFILIATE_COMMISSION\",\"affiliateId\":\"aff_abc123\",\"companyId\":\"comp_xyz\",\"couponCode\":\"AFIL10\",\"orderId\":\"order-123\",\"commissionRate\":10,\"commissionValue\":15.50}"
```

**4. Parse manual para validar:**
```javascript
const ref = '{"type":"AFFILIATE_COMMISSION",...}'
const parsed = JSON.parse(ref)

console.log(parsed.type) // "AFFILIATE_COMMISSION"
console.log(parsed.affiliateId) // "aff_abc123"
console.log(parsed.commissionValue) // 15.50
```

---

## üìä Checklist de Valida√ß√£o

### **Interface:**
- [ ] Tela de loading aparece ao validar token
- [ ] Erro mostrado se token inv√°lido
- [ ] Login/Cadastro aparecem se n√£o autenticado
- [ ] Detalhes do convite vis√≠veis
- [ ] Bot√£o aceitar funciona
- [ ] Box verde OU amarelo aparece conforme caso
- [ ] Dashboard mostra afilia√ß√£o corretamente
- [ ] Aviso amarelo permanente se wallet compartilhada

### **Dados:**
- [ ] Registro criado em `affiliated`
- [ ] Campo `walletSource` preenchido corretamente
- [ ] Campo `ownCompanyId` presente se necess√°rio
- [ ] Convite marcado como ACCEPTED
- [ ] Conta Asaas criada se necess√°rio (verificar logs)

### **L√≥gica:**
- [ ] Detecta empresa do afiliado por CPF/CNPJ
- [ ] Reutiliza wallet se empresa existe
- [ ] Cria nova conta se n√£o existe
- [ ] Valida√ß√µes de dados funcionam
- [ ] ExternalReference cont√©m dados corretos

### **ExternalReference:**
- [ ] Venda SEM afiliado: externalReference = orderId simples
- [ ] Venda COM afiliado: externalReference = JSON com metadados
- [ ] JSON parse√°vel e v√°lido
- [ ] Valores de comiss√£o corretos

---

## üêõ Troubleshooting

### **Problema: "Cannot find module firebase-admin"**
```bash
npm install firebase-admin
```

### **Problema: Convite n√£o aparece no Firestore**
- Verifique credenciais do Firebase no .env.local
- Rode o script com: `node --trace-warnings scripts/create-test-affiliate-invite.js`

### **Problema: "Usu√°rio n√£o possui CPF cadastrado"**
```javascript
// Atualize o usu√°rio no Firestore:
{
  document_number: "12345678900",
  fullName: "Nome Completo",
  email: "email@teste.com"
}
```

### **Problema: Wallet n√£o √© detectada**
- Verifique se empresa tem `walletId` ou `asaasWalletId`
- Verifique se `document_number` da empresa === do usu√°rio
- Confira logs do servidor: `üîç Verificando wallet existente para documento...`

### **Problema: ExternalReference vazio**
- Verifique se cupom tem `affiliateId`
- Confira se splits.affiliateAmount > 0
- Veja logs: `üí∞ Calculando splits...`

---

## üì∏ Screenshots Esperados

### **1. Tela de Aceita√ß√£o (N√£o Logado):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   üéÅ                           ‚îÇ
‚îÇ   Convite de Afiliado          ‚îÇ
‚îÇ                                ‚îÇ
‚îÇ Detalhes do Convite:           ‚îÇ
‚îÇ Empresa: Loja ABC              ‚îÇ
‚îÇ Comiss√£o: 10%                  ‚îÇ
‚îÇ                                ‚îÇ
‚îÇ [  Fazer Login  ]              ‚îÇ
‚îÇ [  Criar Conta  ]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **2. Tela de Sucesso (Wallet Pessoal):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéâ PARAB√âNS! üéâ               ‚îÇ
‚îÇ  Voc√™ agora √© um afiliado!     ‚îÇ
‚îÇ                                ‚îÇ
‚îÇ  ‚úÖ Conta Pessoal Ativa        ‚îÇ
‚îÇ  Suas comiss√µes ser√£o          ‚îÇ
‚îÇ  depositadas na sua conta      ‚îÇ
‚îÇ  pessoal Asaas.                ‚îÇ
‚îÇ                                ‚îÇ
‚îÇ  üìä Informa√ß√µes da Parceria    ‚îÇ
‚îÇ  Empresa: Loja ABC             ‚îÇ
‚îÇ  Comiss√£o: 10%                 ‚îÇ
‚îÇ                                ‚îÇ
‚îÇ  [ Ir para Painel de Afiliado ]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **3. Tela de Sucesso (Wallet Compartilhada):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéâ PARAB√âNS! üéâ               ‚îÇ
‚îÇ  Voc√™ agora √© um afiliado!     ‚îÇ
‚îÇ                                ‚îÇ
‚îÇ  ‚ö†Ô∏è Conta Compartilhada        ‚îÇ
‚îÇ  Suas comiss√µes ser√£o          ‚îÇ
‚îÇ  depositadas na conta da sua   ‚îÇ
‚îÇ  franquia "Minha Loja".        ‚îÇ
‚îÇ  üí∞ Verifique o extrato da     ‚îÇ
‚îÇ  sua empresa.                  ‚îÇ
‚îÇ                                ‚îÇ
‚îÇ  [ Ir para Painel de Afiliado ]‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ Crit√©rios de Sucesso

Teste passou se:
1. ‚úÖ Todos os 4 cen√°rios funcionam corretamente
2. ‚úÖ Avisos corretos aparecem (verde vs amarelo)
3. ‚úÖ Dados salvos corretamente no Firestore
4. ‚úÖ ExternalReference cont√©m dados quando tem afiliado
5. ‚úÖ Dashboard mostra aviso permanente quando necess√°rio

---

**√öltima atualiza√ß√£o:** 30/10/2025  
**Vers√£o:** 1.0
