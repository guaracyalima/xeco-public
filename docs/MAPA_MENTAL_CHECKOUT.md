# ğŸ—ºï¸ Mapa Mental: Checkout Implementation

## ğŸ¯ VisÃ£o Geral Completa do Sistema

```
                           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                           â”ƒ    USER FLOW                      â”ƒ
                           â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                      â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ User clica \"Adicionar ao Carrinho\"    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  âœ… Fase 1: CRIAR ORDER             â”‚
                    â”‚  (Imediately on addToCart)          â”‚
                    â”‚  Firebase Firestore                â”‚
                    â”‚  â””â”€ Cria novo document orders/{id} â”‚
                    â”‚  â””â”€ Status: PENDING_PAYMENT        â”‚
                    â”‚  â””â”€ Armazena: userId, companyId    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ User coleta dados e clica Checkout  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ âœ… Fase 2: PREPARAR PAYLOAD                               â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                                           â”‚
        â”‚ â”Œâ”€ DADOS INTERNOS (Auditoria)                             â”‚
        â”‚ â”‚  â”œâ”€ orderId (Firestore order ID)                       â”‚
        â”‚ â”‚  â”œâ”€ userId (Firebase Auth ID)                          â”‚
        â”‚ â”‚  â””â”€ companyId (Firebase Company ID)                    â”‚
        â”‚ â”‚                                                         â”‚
        â”‚ â”œâ”€ DADOS DE PRODUTOS (ProductList)                       â”‚
        â”‚ â”‚  â”œâ”€ productId                                          â”‚
        â”‚ â”‚  â”œâ”€ productName â† NOVO                                â”‚
        â”‚ â”‚  â”œâ”€ quantity                                           â”‚
        â”‚ â”‚  â”œâ”€ unitPrice â† NOVO                                  â”‚
        â”‚ â”‚  â””â”€ totalPrice â† NOVO (qty Ã— unitPrice)              â”‚
        â”‚ â”‚                                                         â”‚
        â”‚ â”œâ”€ DADOS DE CLIENTE (Asaas)                              â”‚
        â”‚ â”‚  â”œâ”€ name                                               â”‚
        â”‚ â”‚  â”œâ”€ cpfCnpj                                            â”‚
        â”‚ â”‚  â”œâ”€ email                                              â”‚
        â”‚ â”‚  â”œâ”€ phone                                              â”‚
        â”‚ â”‚  â””â”€ address                                            â”‚
        â”‚ â”‚                                                         â”‚
        â”‚ â”œâ”€ DADOS PARA ASAAS                                      â”‚
        â”‚ â”‚  â”œâ”€ items (com imagens base64)                         â”‚
        â”‚ â”‚  â”œâ”€ billingTypes (CREDIT_CARD, PIX)                    â”‚
        â”‚ â”‚  â”œâ”€ chargeTypes (DETACHED)                             â”‚
        â”‚ â”‚  â”œâ”€ totalAmount                                        â”‚
        â”‚ â”‚  â””â”€ dueDate                                            â”‚
        â”‚ â”‚                                                         â”‚
        â”‚ â””â”€ SEGURANÃ‡A (HMAC-SHA256)                                â”‚
        â”‚    â””â”€ signature (companyId + totalAmount + items)         â”‚
        â”‚                                                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ âœ… Fase 3: ENVIAR PARA N8N                                â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                                           â”‚
        â”‚ POST /webhook/checkout                                   â”‚
        â”‚ Content-Type: application/json                           â”‚
        â”‚ Body: {orderId, userId, companyId, productList,          â”‚
        â”‚        customerData, items, signature}                   â”‚
        â”‚                                                           â”‚
        â”‚ Frontend espera: {success, checkoutUrl}                  â”‚
        â”‚                                                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
        â”ƒ ğŸ†• N8N WORKFLOW (PRÃ“XIMA FASE - DOCUMENTADO)               â”ƒ
        â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
        â”ƒ                                                            â”ƒ
        â”ƒ 1ï¸âƒ£  RECEIVE â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ HTTP POST Webhook Trigger        â”‚           â”ƒ
        â”ƒ            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 2ï¸âƒ£  PARSE  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ Execute Node (Log request)      â”‚           â”ƒ
        â”ƒ            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 3ï¸âƒ£  VALIDATE â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”ƒ
        â”ƒ    FIELDS â”‚ Check: orderId? userId?...        â”‚          â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â””â”€ If missing â†’ 400 Error        â”€â”˜          â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 4ï¸âƒ£  QUERY   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”ƒ
        â”ƒ    FIRESTORE â”‚ Firestore: Query orders/{id}    â”‚           â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ Validate: status=PENDING_PAYMENT â”‚           â”ƒ
        â”ƒ            â””â”€ If not found â†’ 404 Error â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 5ï¸âƒ£  VALIDATE â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”ƒ
        â”ƒ    DATA     â”‚ Query users/{userId}            â”‚          â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ Query companies/{companyId}      â”‚          â”ƒ
        â”ƒ            â”‚ Validate: active=true             â”‚          â”ƒ
        â”ƒ            â””â”€ If error â†’ 404/403 Error â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 6ï¸âƒ£  LOOP    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”ƒ
        â”ƒ    PRODUCTS â”‚ For each product in productList  â”‚           â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”ƒ
        â”ƒ            â”Œâ”€ Loop item 1                 â”               â”ƒ
        â”ƒ            â”‚ â”œâ”€ Query products/{id}      â”‚               â”ƒ
        â”ƒ            â”‚ â”œâ”€ Validate: exists?        â”‚               â”ƒ
        â”ƒ            â”‚ â”œâ”€ Validate: name matches?  â”‚               â”ƒ
        â”ƒ            â”‚ â”œâ”€ Validate: price matches? â”‚ FRAUD CHECK    â”ƒ
        â”ƒ            â”‚ â”œâ”€ Validate: stock >= qty?  â”‚               â”ƒ
        â”ƒ            â”‚ â”œâ”€ Validate: total correct? â”‚               â”ƒ
        â”ƒ            â”‚ â””â”€ Accumulate total         â”‚               â”ƒ
        â”ƒ            â”œâ”€ Loop item 2 (idem)        â”‚               â”ƒ
        â”ƒ            â”œâ”€ Loop item 3 (idem)        â”‚               â”ƒ
        â”ƒ            â””â”€ ...                        â”˜               â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 7ï¸âƒ£  VALIDATE â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”ƒ
        â”ƒ    TOTAL    â”‚ Check: sum(totals) == totalAmountâ”‚          â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â””â”€ If wrong â†’ 400 Error â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 8ï¸âƒ£  HMAC    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”ƒ
        â”ƒ    SHA256   â”‚ Execute: HMAC-SHA256 calculationâ”‚           â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ Use: timingSafeEqual comparison â”‚           â”ƒ
        â”ƒ            â””â”€ If invalid â†’ 403 FRAUD! â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 9ï¸âƒ£  EXTRACT â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”ƒ
        â”ƒ    ASAAS    â”‚ Remove: orderId, userId,        â”‚           â”ƒ
        â”ƒ    DATA     â”‚ companyId, productList,         â”‚           â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ signature                       â”‚           â”ƒ
        â”ƒ            â”‚ Keep: items, customer, etc       â”‚           â”ƒ
        â”ƒ            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ ğŸ”Ÿ  ASAAS   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”ƒ
        â”ƒ    API      â”‚ HTTP POST /v3/payments          â”‚            â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ Response: {id, checkoutUrl}     â”‚            â”ƒ
        â”ƒ            â””â”€ If error â†’ 500 Error â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 1ï¸âƒ£1ï¸âƒ£ UPDATE  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”ƒ
        â”ƒ    FIRESTORE â”‚ Update orders/{orderId}        â”‚            â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ asaasPaymentId, checkoutUrl     â”‚            â”ƒ
        â”ƒ            â”‚ status=CHECKOUT_CREATED         â”‚            â”ƒ
        â”ƒ            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”ƒ
        â”ƒ                          â†“                                 â”ƒ
        â”ƒ 1ï¸âƒ£2ï¸âƒ£ RESPOND â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”ƒ
        â”ƒ    FRONTEND â”‚ 200 OK                          â”‚            â”ƒ
        â”ƒ    â””â”€â”€â”€â”€â”€â”€â†’ â”‚ {success: true, checkoutUrl}    â”‚            â”ƒ
        â”ƒ            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”ƒ
        â”ƒ                                                            â”ƒ
        â”ƒ ğŸ’¥ ERROR HANDLING (Qualquer ponto)                        â”ƒ
        â”ƒ    â”œâ”€ 400 Bad Request (validation error)                  â”ƒ
        â”ƒ    â”œâ”€ 403 Forbidden (fraud detected!)                     â”ƒ
        â”ƒ    â”œâ”€ 404 Not Found (missing data)                        â”ƒ
        â”ƒ    â”œâ”€ 422 Unprocessable (insufficient stock)              â”ƒ
        â”ƒ    â””â”€ 500 Internal (API error)                            â”ƒ
        â”ƒ       + Log to console/Slack                              â”ƒ
        â”ƒ       + Update Order status to FAILED                     â”ƒ
        â”ƒ                                                            â”ƒ
        â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
                                      â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Frontend recebe checkoutUrl       â”‚
                    â”‚  Redireciona para Asaas            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Asaas Payment Gateway             â”‚
                    â”‚  â”œâ”€ Exibe items (com fotos)        â”‚
                    â”‚  â”œâ”€ Mostra preÃ§os                  â”‚
                    â”‚  â”œâ”€ OpÃ§Ãµes: CartÃ£o/PIX             â”‚
                    â”‚  â””â”€ Cliente completa pagamento     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  âœ… PAGAMENTO REALIZADO!           â”‚
                    â”‚  Asaas webhook â†’ Order updated     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Matriz de Responsabilidades

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMPONENTE         â”‚ RESPONSABILIDADE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend           â”‚ âœ… Coletar dados                             â”‚
â”‚ (React/Next.js)    â”‚ âœ… Criar Order no Firestore                  â”‚
â”‚                    â”‚ âœ… Preparar payload completo                 â”‚
â”‚                    â”‚ âœ… Calcular HMAC-SHA256                      â”‚
â”‚                    â”‚ âœ… Enviar POST para n8n                      â”‚
â”‚                    â”‚ âœ… Redirecionar para Asaas                   â”‚
â”‚                    â”‚                                              â”‚
â”‚ N8N (Orquestrador) â”‚ â³ Receber webhook POST                      â”‚
â”‚                    â”‚ â³ Validar dados internos                     â”‚
â”‚                    â”‚ â³ Validar produtos & estoque                 â”‚
â”‚                    â”‚ â³ Validar totais                             â”‚
â”‚                    â”‚ â³ Validar signature HMAC                     â”‚
â”‚                    â”‚ â³ Enviar para Asaas API                      â”‚
â”‚                    â”‚ â³ Atualizar Firestore                        â”‚
â”‚                    â”‚ â³ Error handling                             â”‚
â”‚                    â”‚                                              â”‚
â”‚ Firebase           â”‚ âœ… Armazenar Orders                          â”‚
â”‚ (Firestore)        â”‚ âœ… Query Products para validaÃ§Ã£o             â”‚
â”‚                    â”‚ âœ… Update Order status                       â”‚
â”‚                    â”‚                                              â”‚
â”‚ Asaas              â”‚ âœ… Processar pagamento                       â”‚
â”‚ (Payment Gateway)  â”‚ âœ… Retornar checkoutUrl                      â”‚
â”‚                    â”‚ âœ… Enviar status via webhook                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo de Dados (Data Flow)

```
FRONTEND              N8N                    ASAAS            FIRESTORE
   â”‚                  â”‚                       â”‚                   â”‚
   â”‚â”€ POST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                       â”‚                   â”‚
   â”‚  {payload}       â”‚                       â”‚                   â”‚
   â”‚                  â”‚                       â”‚                   â”‚
   â”‚                  â”‚â”€ Query â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                  â”‚  (Order/User/Company)                     â”‚
   â”‚                  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                  â”‚  {result}                                  â”‚
   â”‚                  â”‚                       â”‚                   â”‚
   â”‚                  â”‚â”€ Query â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                  â”‚  (Products)                                â”‚
   â”‚                  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                  â”‚  {result}                                  â”‚
   â”‚                  â”‚                       â”‚                   â”‚
   â”‚                  â”‚â”€ POST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                   â”‚
   â”‚                  â”‚  (Asaas data)         â”‚                   â”‚
   â”‚                  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                   â”‚
   â”‚                  â”‚  {checkoutUrl}        â”‚                   â”‚
   â”‚                  â”‚                       â”‚                   â”‚
   â”‚                  â”‚â”€ Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                  â”‚  (asaasPaymentId)                          â”‚
   â”‚                  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                  â”‚  {ack}                                     â”‚
   â”‚                  â”‚                       â”‚                   â”‚
   â”‚â†â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                   â”‚
   â”‚  {checkoutUrl}   â”‚                       â”‚                   â”‚
   â”‚                  â”‚                       â”‚                   â”‚
   â”‚â”€ Redirect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                   â”‚
   â”‚  (to checkoutUrl)                        â”‚                   â”‚
   â”‚                  â”‚                       â”‚ (Payment)         â”‚
   â”‚                  â”‚                       â”‚ (Webhook)         â”‚
   â”‚                  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
   â”‚                  â”‚  (Status update)      â”‚                   â”‚
   â”‚                  â”‚                       â”‚                   â”‚
   â”‚                  â”‚â”€ Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                  â”‚  (payment status)                          â”‚
   â”‚                  â”‚                       â”‚                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ValidaÃ§Ãµes em Cascade

```
              â”Œâ”€ Frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ 1. Validar campos obrigatÃ³rios            â”‚
              â”‚ 2. Calcular HMAC-SHA256                   â”‚
              â”‚ 3. Validar formato JSON                   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
              â”Œâ”€ API Route â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ 1. Validar signature HMAC                 â”‚
              â”‚ 2. Verificar integraÃ§Ã£o bÃ¡sica            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
              â”Œâ”€ N8N Workflow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                             â”‚
              â”‚ 1ï¸âƒ£ Auditoria:                               â”‚
              â”‚    â”œâ”€ Order existe?                        â”‚
              â”‚    â”œâ”€ User existe?                         â”‚
              â”‚    â””â”€ Company existe?                      â”‚
              â”‚                                             â”‚
              â”‚ 2ï¸âƒ£ Produtos:                                â”‚
              â”‚    â”œâ”€ Cada produto existe?                 â”‚
              â”‚    â”œâ”€ PreÃ§o correto?  â† FRAUD CHECK!      â”‚
              â”‚    â”œâ”€ Estoque suficiente?                  â”‚
              â”‚    â””â”€ Total correto?                       â”‚
              â”‚                                             â”‚
              â”‚ 3ï¸âƒ£ SeguranÃ§a:                               â”‚
              â”‚    â””â”€ HMAC-SHA256 vÃ¡lida?                 â”‚
              â”‚                                             â”‚
              â”‚ 4ï¸âƒ£ Integridade:                             â”‚
              â”‚    â””â”€ Totais conferem?                     â”‚
              â”‚                                             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
              â”Œâ”€ Asaas API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ 1. ValidaÃ§Ãµes internas do Asaas           â”‚
              â”‚ 2. Processamento do pagamento             â”‚
              â”‚ 3. Retorno de status                      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Status Checklist

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FRONTEND IMPLEMENTATION                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Order creation at addToCart                         â”‚
â”‚ âœ… Internal data collection (orderId, userId, company) â”‚
â”‚ âœ… ProductList with full structure                     â”‚
â”‚ âœ… HMAC-SHA256 signature generation                    â”‚
â”‚ âœ… POST to n8n webhook                                 â”‚
â”‚ âœ… TypeScript compilation: NO ERRORS                  â”‚
â”‚ âœ… Build: SUCCESS                                      â”‚
â”‚ âœ… Documentation: COMPLETE                             â”‚
â”‚                                                         â”‚
â”‚ STATUS: âœ… READY FOR N8N                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ N8N IMPLEMENTATION                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ†• Documentation created: 4 files                       â”‚
â”‚ ğŸ†• START_HERE guide: Complete                          â”‚
â”‚ ğŸ†• Payload examples: Complete                          â”‚
â”‚ ğŸ†• Visual diagrams: Complete                           â”‚
â”‚ ğŸ†• Checklist: Complete                                 â”‚
â”‚                                                         â”‚
â”‚ â³ Webhook trigger: NOT STARTED                         â”‚
â”‚ â³ Auditoria validation: NOT STARTED                    â”‚
â”‚ â³ Product validation: NOT STARTED                      â”‚
â”‚ â³ Security validation: NOT STARTED                     â”‚
â”‚ â³ Asaas integration: NOT STARTED                       â”‚
â”‚ â³ Error handling: NOT STARTED                          â”‚
â”‚ â³ Testing: NOT STARTED                                 â”‚
â”‚                                                         â”‚
â”‚ STATUS: â³ READY TO START IMPLEMENTATION               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TESTING                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â³ Happy path test: NOT STARTED                         â”‚
â”‚ â³ Price tampering: NOT STARTED                         â”‚
â”‚ â³ Insufficient stock: NOT STARTED                      â”‚
â”‚ â³ Invalid signature: NOT STARTED                       â”‚
â”‚ â³ End-to-end: NOT STARTED                              â”‚
â”‚                                                         â”‚
â”‚ STATUS: â³ DOCUMENTED                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Learning Path

```
START
  â”‚
  â”œâ”€â†’ ğŸ“š Understand Frontend (5 min)
  â”‚   â””â”€ How data flows from React
  â”‚
  â”œâ”€â†’ ğŸ“š Understand N8N Basics (10 min)
  â”‚   â”œâ”€ What is webhook trigger?
  â”‚   â”œâ”€ What are nodes?
  â”‚   â””â”€ What is conditional logic?
  â”‚
  â”œâ”€â†’ ğŸ“– Read: N8N_START_HERE.md (5 min)
  â”‚   â””â”€ Quick summary of what you'll do
  â”‚
  â”œâ”€â†’ ğŸ“– Read: N8N_PAYLOAD_EXEMPLO_REAL.md (5 min)
  â”‚   â””â”€ See real example of data
  â”‚
  â”œâ”€â†’ ğŸ¨ Read: N8N_WORKFLOW_VISUAL_DIAGRAM.md (10 min)
  â”‚   â””â”€ Visualize complete flow
  â”‚
  â”œâ”€â†’ ğŸ› ï¸ Read: N8N_IMPLEMENTATION_CHECKLIST.md (25 min)
  â”‚   â””â”€ Start building nodes
  â”‚
  â”œâ”€â†’ ğŸ§ª Run Test Cases (60 min)
  â”‚   â”œâ”€ Happy path
  â”‚   â”œâ”€ Error cases
  â”‚   â””â”€ Fraud scenarios
  â”‚
  â””â”€â†’ âœ… COMPLETE!
```

---

_Documento criado: 21 de outubro de 2025_  
_PropÃ³sito: VisualizaÃ§Ã£o completa do sistema_  
_Status: Ready for implementation_
