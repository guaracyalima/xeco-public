# N8N Workflow - Visual Flow Diagram

## ๐ฏ Overview Completo

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   CHECKOUT N8N WORKFLOW                              โ
โ         (From Frontend HTTP POST โ Asaas API โ Order Updated)       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1๏ธโฃ  ENTRADA: HTTP POST Webhook                                   โ
โ    URL: https://n8n.yourapp.com/webhook/checkout                 โ
โ    Body: {orderId, userId, companyId, totalAmount, ...}          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2๏ธโฃ  PARSE: Execute Node (Log Recebimento)                        โ
โ    โโ timestamp: now                                              โ
โ    โโ orderId: received                                           โ
โ    โโ totalAmount: received                                       โ
โ    โโ productCount: received                                      โ
โ                                                                    โ
โ    Output: Logged to Console/Slack                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3๏ธโฃ  VALIDAR: Campos Obrigatรณrios                                 โ
โ    โโ orderId? โ                                                  โ
โ    โโ userId? โ                                                   โ
โ    โโ companyId? โ                                                โ
โ    โโ totalAmount > 0? โ                                          โ
โ    โโ productList[] ? โ                                           โ
โ    โโ signature? โ                                                โ
โ                                                                    โ
โ    โ Se falhar โ Error 400 Bad Request                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4๏ธโฃ  FIRESTORE: Query Order                                       โ
โ    Collection: orders                                              โ
โ    Filter: id = {{orderId}}                                        โ
โ                                                                    โ
โ    Validar:                                                        โ
โ    โโ Existe? โ                                                   โ
โ    โโ customerId == userId? โ                                     โ
โ    โโ company == companyId? โ                                     โ
โ    โโ status == PENDING_PAYMENT? โ                                โ
โ                                                                    โ
โ    โ Se falhar โ Error 404/403/409                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 5๏ธโฃ  FIRESTORE: Query User                                        โ
โ    Collection: users                                               โ
โ    Filter: id = {{userId}}                                         โ
โ                                                                    โ
โ    Validar:                                                        โ
โ    โโ Existe? โ                                                   โ
โ                                                                    โ
โ    โ Se falhar โ Error 404 User Not Found                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 6๏ธโฃ  FIRESTORE: Query Company                                     โ
โ    Collection: companies                                           โ
โ    Filter: id = {{companyId}}                                      โ
โ                                                                    โ
โ    Validar:                                                        โ
โ    โโ Existe? โ                                                   โ
โ    โโ active == true? โ                                           โ
โ                                                                    โ
โ    โ Se falhar โ Error 404/403                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 7๏ธโฃ  LOOP: Para cada item em productList                         โ
โ                                                                    โ
โ    โโ Produto 1 (productId, quantity, unitPrice, totalPrice)    โ
โ    โ  โโ FIRESTORE: Query products/{productId}                   โ
โ    โ  โโ Validar: Existe? โ                                      โ
โ    โ  โโ Validar: Name matches? โ (detect tampering)             โ
โ    โ  โโ Validar: Price matches? โ (FRAUD DETECTION!)            โ
โ    โ  โโ Validar: Stock >= quantity? โ                           โ
โ    โ  โโ Validar: totalPrice == qty ร unitPrice? โ               โ
โ    โ  โโ Acumular: cumulativeTotal += totalPrice                 โ
โ    โ                                                               โ
โ    โโ Produto 2 (idem)                                            โ
โ    โ                                                               โ
โ    โโ Produto 3 (idem)                                            โ
โ    โ                                                               โ
โ    โโ ...                                                          โ
โ                                                                    โ
โ    โ Se qualquer falhar:                                         โ
โ       โ Error 404 (not found)                                     โ
โ       โ Error 400 (mismatch/tampering)                            โ
โ       โ Error 422 (insufficient stock)                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 8๏ธโฃ  VALIDAR: Total Geral                                         โ
โ    Condition: Math.abs(cumulativeTotal - totalAmount) < 0.01      โ
โ                                                                    โ
โ    โ Se falhar โ Error 400 Total Amount Mismatch                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 9๏ธโฃ  SECURITY: Validar HMAC-SHA256 Signature                      โ
โ    Execute Node (Crypto):                                          โ
โ    โโ Rebuild data: {companyId, totalAmount, items[]}             โ
โ    โโ Load secret: process.env.CHECKOUT_SIGNATURE_SECRET           โ
โ    โโ Calculate: HMAC-SHA256 (data with secret)                    โ
โ    โโ Compare: calculatedSignature === receivedSignature           โ
โ    โโ Use: timingSafeEqual (prevent timing attacks)                โ
โ                                                                    โ
โ    โ Se falhar โ Error 403 Forbidden (FRAUD!)                    โ
โ       Alert: Slack notification sent                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐  PREPARE: Extrair dados para Asaas                             โ
โ    Remove (dados internos):                                        โ
โ    โโ orderId                                                      โ
โ    โโ userId                                                       โ
โ    โโ companyId                                                    โ
โ    โโ productList                                                  โ
โ    โโ signature                                                    โ
โ                                                                    โ
โ    Keep (dados Asaas):                                             โ
โ    โโ billingTypes                                                 โ
โ    โโ chargeTypes                                                  โ
โ    โโ items (com imagens base64)                                   โ
โ    โโ customerData (nome, cpf, email, etc)                         โ
โ    โโ totalAmount                                                  โ
โ    โโ dueDate                                                      โ
โ                                                                    โ
โ    Add metadata:                                                   โ
โ    โโ description: "Order: {{orderId}}"                            โ
โ    โโ externalReference: "{{orderId}}"                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1๏ธโฃ1๏ธโฃ  HTTP POST: Chamar Asaas API                                โ
โ    URL: https://api.asaas.com/v3/payments                          โ
โ    Method: POST                                                    โ
โ    Header: X-API-KEY: {{ASAAS_API_KEY}}                            โ
โ    Body: {{asaasPayload}}                                          โ
โ                                                                    โ
โ    Expected Response:                                              โ
โ    {                                                               โ
โ      "id": "pay_xxx",                                              โ
โ      "object": "payment",                                          โ
โ      "status": "PENDING",                                          โ
โ      "checkoutUrl": "https://checkout.asaas.com/..."              โ
โ    }                                                               โ
โ                                                                    โ
โ    โ Se falhar โ Error 500 Asaas Error                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1๏ธโฃ2๏ธโฃ  FIRESTORE: Update Order Document                           โ
โ    Collection: orders                                              โ
โ    Document: {{orderId}}                                           โ
โ                                                                    โ
โ    Update:                                                         โ
โ    {                                                               โ
โ      "asaasPaymentId": "pay_xxx",                                  โ
โ      "checkoutUrl": "https://checkout.asaas.com/...",             โ
โ      "status": "CHECKOUT_CREATED",                                 โ
โ      "updatedAt": new Date().toISOString()                         โ
โ    }                                                               โ
โ                                                                    โ
โ    โ Se falhar โ Log erro mas continua                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1๏ธโฃ3๏ธโฃ  RESPOND: Enviar resposta para Frontend                     โ
โ    Status: 200 OK                                                  โ
โ    Body:                                                           โ
โ    {                                                               โ
โ      "success": true,                                              โ
โ      "checkoutUrl": "https://checkout.asaas.com/...",             โ
โ      "message": "Checkout criado com sucesso"                     โ
โ    }                                                               โ
โ                                                                    โ
โ    Frontend redireciona para checkoutUrl ๐                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ERROR HANDLING (Any point)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ
โ                                                                    โ
โ  โ ERROR TRIGGERED:                                              โ
โ     โโ Catch error in dedicated Error Node                        โ
โ     โโ Determine status code (400/403/404/409/422/500)            โ
โ     โโ Log to Console + Slack                                     โ
โ     โโ Update Order status to "CHECKOUT_FAILED"                   โ
โ     โโ Store error reason in Order document                       โ
โ     โโ Respond with:                                              โ
โ                                                                    โ
โ        {                                                           โ
โ          "success": false,                                         โ
โ          "error": "PRICE_MISMATCH",                                โ
โ          "message": "Expected 75.25, got 10.00",                  โ
โ          "orderId": "order-123",                                   โ
โ          "timestamp": "2025-10-21T14:30:50Z"                      โ
โ        }                                                           โ
โ                                                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ Node Configuration Summary

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ NODE NAME              โ TYPE              โ PURPOSE          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ HTTP Webhook Trigger   โ Trigger (HTTP)    โ Receive POST     โ
โ Log Entry              โ Execute (JS)      โ Log request      โ
โ Validate Fields        โ Set               โ Validate basic   โ
โ Query Order            โ Firestore         โ Get order data   โ
โ Query User             โ Firestore         โ Get user data    โ
โ Query Company          โ Firestore         โ Get company data โ
โ Prepare Products Loop  โ Set               โ Prep array       โ
โ Loop Products          โ Loop              โ Iterate items    โ
โ Query Product          โ Firestore         โ Get prod data    โ
โ Check Product Exists   โ If                โ Validate exists  โ
โ Check Name Match       โ If                โ Fraud detect     โ
โ Check Price Match      โ If                โ FRAUD DETECT!!   โ
โ Check Stock            โ If                โ Validate stock   โ
โ Check Item Total       โ If                โ Validate calc    โ
โ Sum Totals             โ Execute (JS)      โ Accumulate       โ
โ Check Total Amount     โ If                โ Validate sum     โ
โ Validate Signature     โ Execute (JS)      โ HMAC-SHA256      โ
โ Check Signature Valid  โ If                โ Fraud detect     โ
โ Prepare Asaas Data     โ Set               โ Extract fields   โ
โ Call Asaas API         โ HTTP Request      โ POST to Asaas    โ
โ Update Order Asaas     โ Firestore         โ Store payment ID โ
โ Response Success       โ Respond to Webhookโ Send checkoutUrl โ
โ Error Handler          โ Error Handler     โ Catch all errors โ
โ Respond Error          โ Respond to Webhookโ Send error msg   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Data Flow Between Nodes

```
โโโโโโโโโโโโโโโโโโโ
โ Frontend POST   โ
โ {body: {...}}   โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Parse & Log              โ
โ $json = body             โ
โ log(orderId, totalAmount)โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Validate Fields          โ
โ Check: orderId exist?    โ
โ Check: totalAmount > 0?  โ
โ etc                      โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโ(Success)โ Continue to Queries
         โโ(Error)โโ Error Handler โ 400 Response
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Firestore Queries        โ
โ Query orders, users, ...โ
โ Store in $json.*         โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโ(Not Found)โ Error Handler โ 404 Response
         โโ(Found)โโโโโ Prep Loop
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Loop Products            โ
โ For each: {productId}    โ
โ $item = current item     โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโโ(Loop)โโโโโ Query Product
         โ             Validate each field
         โ             Accumulate total
         โโ(Complete)โ Post-Loop Validation
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Validate Total           โ
โ cumulativeTotal          โ
โ vs totalAmount           โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโ(Mismatch)โ Error Handler โ 400
         โโ(Match)โโโโ Signature Validation
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Validate Signature       โ
โ HMAC-SHA256 check        โ
โ timingSafeEqual()        โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโ(Invalid)โ Error Handler โ 403 (FRAUD!)
         โโ(Valid)โโโ Prepare Asaas Data
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Extract Asaas Data       โ
โ Remove: orderId,userId   โ
โ Keep: items, customer    โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Call Asaas API           โ
โ POST /v3/payments        โ
โ Response: {id, url}      โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โโ(Error)โ Error Handler โ 500
         โโ(Success)โ Update Order
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Update Firestore         โ
โ Store asaasPaymentId     โ
โ Store checkoutUrl        โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
         โ
         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Response 200 OK          โ
โ {checkoutUrl, success}   โ
โ Frontend redirects       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ก Implementation Tips

1. **Use Set nodes** to prepare data before loops
2. **Use If nodes** for conditional branching
3. **Always log** before/after major steps
4. **Use Firestore carefully** - each query costs
5. **Implement error handling** at each critical point
6. **Test each node individually** before full workflow
7. **Use Slack alerts** for fraud detections
8. **Monitor Asaas API** rate limits
9. **Keep error messages clear** for debugging
10. **Document** each node's exact configuration

---

**Bora comeรงar a implementar! ๐**
